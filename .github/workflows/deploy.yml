name: deploy-to-azure-workflow
run-name: ${{ github.sha }} deploy
on: [push]

permissions:
  id-token: write
  contents: read

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Debug Azure secrets presence
        run: |
            test -n "${{ secrets.AZURE_CLIENT_ID }}" && echo "AZURE_CLIENT_ID: set" || echo "AZURE_CLIENT_ID: MISSING"
            test -n "${{ secrets.AZURE_TENANT_ID }}" && echo "AZURE_TENANT_ID: set" || echo "AZURE_TENANT_ID: MISSING"
            test -n "${{ secrets.AZURE_SUBSCRIPTION_ID }}" && echo "AZURE_SUBSCRIPTION_ID: set" || echo "AZURE_SUBSCRIPTION_ID: MISSING"  

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  
      - name: Login to ACR
        run: az acr login --name ${{ vars.AZURE_ACR_NAME }}

      - name: Set image tag
        run: echo "IMAGE_TAG=${GITHUB_SHA}" >> $GITHUB_ENV

      - name: Build and push image (linux/amd64)
        run: |
          ACR_LOGIN_SERVER=$(az acr show -n "${{ vars.AZURE_ACR_NAME }}" --query loginServer -o tsv)
          IMAGE="$ACR_LOGIN_SERVER/filevault:${IMAGE_TAG}"

          docker buildx create --use || true
          docker buildx build \
            --platform linux/amd64 \
            -t "$IMAGE" \
            --push \
            .

          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Deploy to Azure Container App
        run: |
          az containerapp update \
            -g "${{ vars.AZURE_RESOURCE_GROUP }}" \
            -n "${{ vars.AZURE_CONTAINERAPP_NAME }}" \
            --image "$IMAGE"